<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>林茵燎點餐助手</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; }
        body { font-family: sans-serif; background: #f4f4f7; padding: 20px; margin: 0; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 10px auto; }
        h2 { color: var(--line-green); text-align: center; margin-top: 0; }
        .section { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 6px; font-size: 0.9rem; color: #333; }
        select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: white; box-sizing: border-box; }
        textarea { height: 85px; resize: none; font-family: inherit; font-size: 0.9rem; line-height: 1.4; }
        .segmented-control { display: flex; gap: 8px; }
        .segment-item { flex: 1; text-align: center; padding: 10px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; background: #fafafa; font-size: 0.85rem; }
        .segment-item.active { border-color: var(--line-green); background: #e6ffef; color: var(--line-green); font-weight: bold; }
        button { width: 100%; padding: 16px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; cursor: pointer; }
        #status { text-align: center; font-size: 0.7rem; color: #999; margin-top: 12px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="storeTitle">讀取中...</h2>
        <div class="section">
            <label>1. 選擇品項</label>
            <select id="itemSelect" onchange="updateOptions()"></select>
        </div>
        <div class="section">
            <label>2. 尺寸</label>
            <div class="segmented-control" id="sizeGroup"></div>
        </div>
        <div class="section" style="display: flex; gap: 10px;">
            <div style="flex:1"><label>3. 冰塊</label><select id="iceSelect"></select></div>
            <div style="flex:1"><label>4. 甜度</label><select id="sugarSelect"></select></div>
        </div>
        <div class="section"><label>5. 加料</label><select id="toppingSelect"></select></div>
        <div class="section">
            <label>6. 備註 / 自定義品項</label>
            <textarea id="noteInput" placeholder="● 加特殊料&#10;● 自定義品項：請在此輸入名稱&#10;● 下方選項請照常點選"></textarea>
        </div>
        <div class="section">
            <label>7. 誰要喝？</label>
            <div class="segmented-control" id="typeGroup">
                <div class="segment-item active" onclick="selectType(this, '自己點')">我自己喝</div>
                <div class="segment-item" onclick="selectType(this, '代點')">幫別人點</div>
            </div>
        </div>
        <button onclick="submitOrder()">送出訂單</button>
        <div id="status">同步中...</div>
    </div>

    <script>
        let menuData = [], selectedSize = "", selectedType = "自己點";
        const liffId = "2008930067-ncNoJlEK";
        const backendBase = "https://deana-postexilian-trena.ngrok-free.dev"; // 記得替換

        liff.init({ liffId }).then(() => {
            const store = new URLSearchParams(window.location.search).get('store');
            if (store) loadMenu(store);
        });

        async function loadMenu(store) {
            document.getElementById('storeTitle').innerText = store;
            try {
                const res = await fetch(`${backendBase}/get_menu?store=${encodeURIComponent(store)}`, { headers: {"ngrok-skip-browser-warning":"true"} });
                const data = await res.json();
                menuData = data.menu;
                const itemSelect = document.getElementById('itemSelect');
                itemSelect.innerHTML = '<option value="自定義品項">自定義品項</option>';
                const categories = {};
                menuData.forEach(i => { 
                    const cat = i.category || "其他";
                    if(!categories[cat]) categories[cat]=[]; 
                    categories[cat].push(i); 
                });
                for (let cat in categories) {
                    let group = document.createElement('optgroup'); group.label = cat;
                    categories[cat].forEach(i => { 
                        let opt = document.createElement('option'); opt.value = i.name; opt.innerText = i.name; group.appendChild(opt); 
                    });
                    itemSelect.appendChild(group);
                }
                updateOptions();
                document.getElementById('status').innerText = "✅ 菜單同步成功";
            } catch (e) { document.getElementById('status').innerText = "❌ 載入失敗"; }
        }

        function selectSize(el, val) {
            document.querySelectorAll('#sizeGroup .segment-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active'); selectedSize = val;
        }

        function selectType(el, val) {
            document.querySelectorAll('#typeGroup .segment-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active'); selectedType = val;
        }

        function updateOptions() {
            const itemVal = document.getElementById('itemSelect').value;
            let selected = menuData.find(i => i.name === itemVal);
            if (itemVal === "自定義品項") {
                selected = { price: "中:0,大:0", ice: "正常,少冰,微冰,去冰,熱", sugar: "正常,半糖,微糖,無糖", toppings: "" };
            }
            if (!selected) return;

            const sizeGroup = document.getElementById('sizeGroup');
            let pricePairs = (selected.price || "0").toString().split(',').filter(p => p.trim() !== "");
            if (pricePairs.length > 1) pricePairs.reverse(); // 對調讓大杯在左
            sizeGroup.innerHTML = pricePairs.map((p, idx) => {
                const [label, price] = p.includes(':') ? p.split(':') : ['大', p];
                if(idx === 0) selectedSize = label;
                return `<div class="segment-item ${idx===0?'active':''}" onclick="selectSize(this, '${label}')">${label}<br><small>$${price}</small></div>`;
            }).join('');

            document.getElementById('iceSelect').innerHTML = (selected.ice || "正常").split(',').map(v => `<option value="${v}">${v}</option>`).join('');
            document.getElementById('sugarSelect').innerHTML = (selected.sugar || "正常").split(',').map(v => `<option value="${v}">${v}</option>`).join('');
            const toppings = (selected.toppings || "").split(',').filter(v => v.trim() !== "");
            document.getElementById('toppingSelect').innerHTML = '<option value="無">無</option>' + toppings.map(v => `<option value="${v}">${v}</option>`).join('');
        }

        async function submitOrder() {
            const store = document.getElementById('storeTitle').innerText;
            const item = document.getElementById('itemSelect').value;
            const ice = document.getElementById('iceSelect').value;
            const sugar = document.getElementById('sugarSelect').value;
            const topping = document.getElementById('toppingSelect').value;
            const note = document.getElementById('noteInput').value.trim() || "無";
            
            document.getElementById('status').innerText = "⏳ 傳送中...";
            
            try {
				const profile = await liff.getProfile(); // 這步會強制觸發授權
				const context = liff.getContext();
				
				// 優先順序：群組ID > 聊天室ID > 個人ID
				let targetId = context.groupId || context.roomId || profile.userId;

				// 如果還是抓到帶橫線的 UUID，就強制用個人的真實 ID
				if (!targetId || targetId.includes('-')) {
					targetId = profile.userId; 
				}

				console.log("最終傳送 ID:", targetId);

				await fetch(`${backendBase}/submit_order_direct`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						// ... 其他資料 ...
						targetId: targetId
					})
				});
				liff.closeWindow();
			} catch (e) {
				alert("請先同意授權才能點餐喔！");
			}
        }
    </script>
</body>
</html>
