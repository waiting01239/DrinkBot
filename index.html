<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—èŒµç‡é»é¤åŠ©æ‰‹</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-gray: #f4f4f7; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg-gray); margin: 0; padding: 20px; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        .menu-img { width: 100%; border-radius: 8px; margin-bottom: 10px; display: none; border: 1px solid #eee; }
        .link-btn { display: block; text-align: center; color: #666; font-size: 0.85rem; margin-bottom: 20px; text-decoration: none; border: 1px solid #ddd; padding: 8px; border-radius: 20px; }
        h2 { color: var(--line-green); text-align: center; margin: 0 0 15px 0; }
        .section { margin-bottom: 18px; }
        label { display: block; font-weight: bold; margin-bottom: 6px; font-size: 0.9rem; color: #444; }
        select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background: #fff; appearance: none; }
        optgroup { font-style: normal; font-weight: bold; color: var(--line-green); }
        button { width: 100%; padding: 16px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { background: #05a847; }
        #status { text-align: center; font-size: 0.75rem; color: #bbb; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="storeTitle">è®€å–ä¸­...</h2>
        <img id="menuImg" class="menu-img" src="" alt="èœå–®åœ–ç‰‡">
        <a id="webLink" class="link-btn" href="#" target="_blank">ğŸ”— å‰å¾€å®˜ç¶²èœå–®ç¶²é </a>

        <div class="section">
            <label>1. é¸æ“‡å“é …</label>
            <select id="itemSelect" onchange="updateOptions()"></select>
        </div>

        <div class="section" style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>2. å†°å¡Š</label>
                <select id="iceSelect"></select>
            </div>
            <div style="flex: 1;">
                <label>3. ç”œåº¦</label>
                <select id="sugarSelect"></select>
            </div>
        </div>

        <div class="section">
            <label>4. åŠ æ–™ (é¸å¡«)</label>
            <select id="toppingSelect"></select>
        </div>

        <div class="section">
            <label>5. èª°è¦å–ï¼Ÿ</label>
            <select id="typeSelect">
                <option value="è‡ªå·±é»">æˆ‘è‡ªå·±å–</option>
                <option value="ä»£é»">å¹«åˆ¥äººé»</option>
            </select>
        </div>

        <button onclick="submitOrder()">ç¢ºèªé»é¤ä¸¦é€å‡º</button>
        <div id="status">æ­£åœ¨å¾é›²ç«¯åŒæ­¥èœå–®...</div>
    </div>

    <script>
        let menuData = [];
        const liffId = "2008930067-ncNoJlEK";
        const backendBase = "https://deana-postexilian-trena.ngrok-free.dev"; // å‹™å¿…æ›´æ›ç‚ºä½ çš„ ngrok ç¶²å€

        liff.init({ liffId }).then(() => {
            if (!liff.isLoggedIn()) liff.login();
            const urlParams = new URLSearchParams(window.location.search);
            const store = urlParams.get('store');
            if (store) loadMenu(store);
        }).catch(err => alert("LIFF åˆå§‹åŒ–å¤±æ•—"));

        async function loadMenu(store) {
			document.getElementById('storeTitle').innerText = store;
			try {
				// 1. æŠ“å–è³‡æ–™ï¼Œè¨˜å¾—åŠ ä¸Š ngrok è·³éè­¦å‘Šçš„æ¨™é ­
				const res = await fetch(`${backendBase}/get_menu?store=${encodeURIComponent(store)}`, {
					headers: { "ngrok-skip-browser-warning": "true" }
				});
				const data = await res.json();
				
				// 2. æ ¸å¿ƒä¿®æ­£ï¼šå¾ data.menu æŠ“å–åˆ—è¡¨ (å°æ‡‰ä½ æˆªåœ–ä¸­çš„ "menu" é‘°åŒ™)
				menuData = data.menu; 

				const itemSelect = document.getElementById('itemSelect');
				itemSelect.innerHTML = ""; // å…ˆæ¸…ç©º

				// 3. æ¸²æŸ“é¸å–®
				menuData.forEach(i => {
					let opt = document.createElement('option');
					opt.value = i.name;
					opt.innerText = `${i.name} ($${i.price})`;
					itemSelect.appendChild(opt);
				});

				// 4. æ›´æ–°åœ–ç‰‡èˆ‡å®˜ç¶²é€£çµ (å°æ‡‰ä½ æˆªåœ–ä¸­çš„ "img" èˆ‡ "url" é‘°åŒ™)
				if (data.img && data.img.startsWith('http')) {
					const img = document.getElementById('menuImg');
					img.src = data.img;
					img.style.display = 'block';
				}
				document.getElementById('webLink').href = data.url || "#";

				updateOptions();
				document.getElementById('status').innerText = "âœ… èœå–®åŒæ­¥æˆåŠŸ";
			} catch (e) {
				console.error(e);
				document.getElementById('status').innerText = "âŒ èœå–®è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æ ¼å¼";
			}
		}

        function updateOptions() {
            const selected = menuData.find(i => i.name === document.getElementById('itemSelect').value);
            document.getElementById('iceSelect').innerHTML = selected.ice.split(',').map(v => `<option value="${v}">${v}</option>`).join('');
            document.getElementById('sugarSelect').innerHTML = selected.sugar.split(',').map(v => `<option value="${v}">${v}</option>`).join('');
            document.getElementById('toppingSelect').innerHTML = '<option value="">ç„¡</option>' + 
                selected.toppings.split(',').map(v => `<option value="${v}">${v}</option>`).join('');
        }

        function submitOrder() {
            const store = document.getElementById('storeTitle').innerText;
            const item = document.getElementById('itemSelect').value;
            const ice = document.getElementById('iceSelect').value;
            const sugar = document.getElementById('sugarSelect').value;
            const topping = document.getElementById('toppingSelect').value;
            const type = document.getElementById('typeSelect').value;

            const msg = `#é»é¤ ${store}/${item}/${ice}/${sugar}/${topping}/${type}`;
            liff.sendMessages([{ type: 'text', text: msg }]).then(() => liff.closeWindow());
        }
    </script>
</body>
</html>
