<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—èŒµç‡é»é¤åŠ©æ‰‹</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --line-green: #06C755; --bg-gray: #f4f4f7; }
        body { font-family: sans-serif; background: var(--bg-gray); padding: 20px; }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .menu-img { width: 100%; border-radius: 8px; margin-bottom: 15px; display: none; }
        .link-btn { display: block; text-align: center; color: #555; font-size: 0.8rem; margin-bottom: 15px; text-decoration: none; }
        h2 { color: var(--line-green); text-align: center; margin-top: 0; }
        .section { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        select, .opt-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        optgroup { font-style: normal; font-weight: bold; color: var(--line-green); }
        button { width: 100%; padding: 16px; background: var(--line-green); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        #status { text-align: center; font-size: 0.7rem; color: #ccc; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="storeTitle">è®€å–ä¸­...</h2>
        <img id="menuImg" class="menu-img" src="" alt="èœå–®åœ–ç‰‡">
        <a id="webLink" class="link-btn" href="#" target="_blank">ğŸ”— å‰å¾€å®˜ç¶²èœå–®</a>

        <div class="section">
            <label>é¸æ“‡å“é … (ä¾åˆ†é¡æ’åº)</label>
            <select id="itemSelect" onchange="updateOptions()"></select>
        </div>

        <div class="section">
            <label>å†°å¡Š</label>
            <select id="iceSelect"></select>
        </div>

        <div class="section">
            <label>ç”œåº¦</label>
            <select id="sugarSelect"></select>
        </div>

        <div class="section">
            <label>åŠ æ–™ (é¸å¡«)</label>
            <select id="toppingSelect"><option value="">ç„¡</option></select>
        </div>

        <div class="section">
            <label>é€™æ¯èª°å–ï¼Ÿ</label>
            <select id="typeSelect"><option value="è‡ªå·±é»">æˆ‘è‡ªå·±</option><option value="ä»£é»">å¹«äººé»</option></select>
        </div>

        <button onclick="submitOrder()">ç¢ºèªé€å‡º</button>
        <div id="status">æ­£åœ¨åŒæ­¥è©¦ç®—è¡¨èœå–®...</div>
    </div>

    <script>
        let menuItems = [];
        const liffId = "2008930067-ncNoJlEK";

        liff.init({ liffId }).then(() => {
            if (!liff.isLoggedIn()) liff.login();
            fetchMenu();
        });

        async function fetchMenu() {
            const urlParams = new URLSearchParams(window.location.search);
            const storeName = urlParams.get('store');
            document.getElementById('storeTitle').innerText = storeName;

            // é€™è£¡æ¨¡æ“¬å¾å¾Œç«¯æŠ“è³‡æ–™ï¼Œå¯¦å‹™ä¸Šä½ å¯ä»¥é€é Google Apps Script å™´ JSON æˆ–ç”± app.py æä¾›
            // ç‚ºäº†ç°¡åŒ–ç’°å¢ƒæ¶è¨­ï¼Œæˆ‘å€‘å…ˆå‡è¨­å¾å¾Œç«¯ API å–å¾—
            const response = await fetch(`https://ä½ çš„NGROKç¶²å€/get_menu?store=${encodeURIComponent(storeName)}`);
            const data = await response.json();
            
            menuItems = data.menu;
            document.getElementById('menuImg').src = data.img;
            document.getElementById('menuImg').style.display = 'block';
            document.getElementById('webLink').href = data.url;

            const itemSelect = document.getElementById('itemSelect');
            let groups = {};
            menuItems.forEach(i => {
                if(!groups[i.category]) groups[i.category] = [];
                groups[i.category].push(i);
            });

            for(let cat in groups) {
                let group = document.createElement('optgroup');
                group.label = cat;
                groups[cat].forEach(i => {
                    let opt = document.createElement('option');
                    opt.value = i.name;
                    opt.innerText = `${i.name} ($${i.price})`;
                    group.appendChild(opt);
                });
                itemSelect.appendChild(group);
            }
            updateOptions();
            document.getElementById('status').innerText = "âœ… èœå–®åŒæ­¥æˆåŠŸ";
        }

        function updateOptions() {
            const selectedItem = menuItems.find(i => i.name === document.getElementById('itemSelect').value);
            const iceS = document.getElementById('iceSelect');
            const sugarS = document.getElementById('sugarSelect');
            const topS = document.getElementById('toppingSelect');

            iceS.innerHTML = selectedItem.ice.split(',').map(v => `<option value="${v}">${v}</option>`).join('');
            sugarS.innerHTML = selectedItem.sugar.split(',').map(v => `<option value="${v}">${v}</option>`).join('');
            topS.innerHTML = '<option value="">ç„¡</option>' + selectedItem.toppings.split(',').map(v => `<option value="${v}">${v}</option>`).join('');
        }

        function submitOrder() {
            const store = document.getElementById('storeTitle').innerText;
            const item = document.getElementById('itemSelect').value;
            const ice = document.getElementById('iceSelect').value;
            const sugar = document.getElementById('sugarSelect').value;
            const topping = document.getElementById('toppingSelect').value;
            const type = document.getElementById('typeSelect').value;

            const msg = `#é»é¤ ${store}/${item}/${ice}/${sugar}/${topping}/${type}`;
            liff.sendMessages([{ type: 'text', text: msg }]).then(() => liff.closeWindow());
        }
    </script>
</body>
</html>
